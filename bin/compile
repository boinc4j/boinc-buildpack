#!/usr/bin/env bash

# fail fast
set -eu

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
BP_DIR=$BIN_DIR/..
OPT_DIR=$BP_DIR/opt/
LIB_DIR=$BP_DIR/lib/

. $LIB_DIR/common.sh
. $LIB_DIR/db.sh
. $LIB_DIR/deps.sh
. $LIB_DIR/boinc.sh

export_env_dir $ENV_DIR


### Validate App

if [ -z "$APP_NAME" ]; then
  # Once dyno metadata is available, we can drop this
  echo "ERROR: You must set APP_NAME manually."
  exit 1
fi

if [ ! -d $BUILD_DIR/target/boinc/app ]; then
  echo "ERROR: No app found in target/boinc/app"
  #exit 1
fi

if [ -n "${JAWSDB_URL:-""}" ]; then
  export_db_props "$JAWSDB_URL"
elif [ -n "${CLEARDB_DATABASE_URL:-""}" ]; then
  export_db_props "$CLEARDB_DATABASE_URL"
else
  echo "ERROR: You must provision a database: $ heroku addons:create cleardb"
  exit 1
fi

# unpack existing cache
CACHED_DIRS="boinc-src .apt project"
for DIR in $CACHED_DIRS; do
  if [ ! -d $BUILD_DIR/$DIR ]; then
    cache_copy $DIR $CACHE_DIR $BUILD_DIR
  fi
done

if [ -n "${REINSTALL_DEPS:-""}" ] || [ ! -d $BUILD_DIR/.apt ]; then
  rm -rf $BUILD_DIR/.apt
  install_deps $BUILD_DIR "mysql-client python-mysqldb"
else
  echo "-----> Using cached dependencies... "
fi

BOINC_DIR=/app/boinc-src
if [ -n "${REBUILD_BOINC:-""}" ] || [ ! -d $BUILD_DIR/boinc-src ]; then
  mkdir -p $BOINC_DIR
  install_boinc $BOINC_DIR
else
  echo "-----> Using cached BOINC Server... "
  mv $BUILD_DIR/boinc-src $BOINC_DIR
fi

echo "-----> Making BOINC Project... "

export PATH=$BUILD_DIR/.apt/usr/sbin:$BUILD_DIR/.apt/usr/bin:$PATH
export PYTHONPATH=$BUILD_DIR/.apt/usr/lib/python2.7/dist-packages
export PATH=/app/.heroku/php/bin:$BUILD_DIR/.heroku/php/bin:$PATH

# Whatever this is used for probably needs to be scrubed in profile.d
export USER=$(whoami)

cd $BOINC_DIR

# Never create the db, but still load the schema
sed -i.bak s/cursor.execute\(\"create\ database/\#cursor.execute\(\"create\ database/g py/Boinc/database.py

if [ -f $BUILD_DIR/project/config.xml ]; then
  # There's a bug here. If the cache is purged, the make_project will fail because the tables exist
  # This really needs to check if the tables exist, not the config
  NO_DB="--no_db"
fi

BOINC_PROJECT_DIR=/app/project
DB_OPTS="--db_host $DATABASE_HOST --db_name $DATABASE_NAME --db_user $DATABASE_USERNAME --db_passwd $DATABASE_PASSWORD ${NO_DB:-""}"
./tools/make_project $DB_OPTS \
                     --user_name $(whoami) --no_query --srcdir $BOINC_DIR --project_root $BOINC_PROJECT_DIR \
                     --url_base "https://$APP_NAME.herokuapp.com" --project_host "$APP_NAME.herokuapp.com" \
                     boinc "BOINC Template" | indent


echo "-----> Installing BOINC App... "
cd $BOINC_PROJECT_DIR
add_project_xml $BOINC_PROJECT_DIR/project.xml $APP_NAME
bin/xadd | indent

# TODO
env

#mv $BUILD_DIR/target/boinc/app $BOINC_PROJECT_DIR/project/apps/$APP_NAME
mkdir -p apps/$APP_NAME/1/x86_64-apple-darwin
echo "
#!/usr/bin/env bash
echo foobar
" >  apps/$APP_NAME/1/x86_64-apple-darwin/test.sh
chmod +x apps/$APP_NAME/1/x86_64-apple-darwin/test.sh

$BOINC_DIR/lib/crypt_prog -sign apps/$APP_NAME/1/x86_64-apple-darwin/test.sh keys/code_sign_private > apps/$APP_NAME/1/x86_64-apple-darwin/test.sh.sig

# We might need to cache these instead
rm keys/code_sign_private
rm keys/upload_private

yes | bin/update_versions | indent
cd - > /dev/null 2>&1

echo "-----> Finalizing... "
rm -rf $BUILD_DIR/project
mv $BOINC_PROJECT_DIR $BUILD_DIR/project

rm -rf $BUILD_DIR/boinc-src
mv $BOINC_DIR $BUILD_DIR/boinc-src

# populate profile.d
PROFILE_PATH="$BUILD_DIR/.profile.d/boinc.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "export PYTHONPATH=\$HOME/.apt/usr/lib/python2.7/dist-packages" >> $PROFILE_PATH

# repack cache with new assets
mkdir -p $CACHE_DIR
for DIR in $CACHED_DIRS; do
  cache_copy $DIR $BUILD_DIR $CACHE_DIR
done

# Remove build-only files from slug
rm -rf $BUILD_DIR/boinc-src
rm -rf $BUILD_DIR/.apt
